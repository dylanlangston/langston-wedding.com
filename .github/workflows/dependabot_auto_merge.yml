name: Dependabot Auto-Merge
on: pull_request

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: merge-${{ github.ref }}
  cancel-in-progress: false

jobs:
  Test:
    name: "Test"
    uses: dylanlangston/langston-wedding.com/.github/workflows/test.yml@main
    permissions:
      contents: read
  dependabot:
    name: "Enable Auto-Merge"
    runs-on: ubuntu-latest
    needs: [Test]
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Enable auto-merge for Dependabot PRs
        run: |
          for i in $(seq 1 5); do
            if gh pr merge --auto --merge "$PR_URL"; then
              break
            elif [ $? -eq 1 ]; then
              sleep $(shuf -i 5-15 -n 1)
            else
              exit 1
            fi
          done
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GH_TOKEN: ${{secrets.PERSONAL_ACCESS_TOKEN}}
